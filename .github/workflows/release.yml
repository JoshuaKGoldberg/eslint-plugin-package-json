name: Release

on:
  push:
    branches:
      - beta
      - main

concurrency:
  group: ${{ github.workflow }}

jobs:
  release_please:
    name: Manage Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          config-file: .github/release-please/release-please-config.${{ github.ref_name }}.json
          manifest-file: .github/release-please/release-please-manifest.json
          target-branch: ${{ github.ref_name }}

  publish:
    name: Publish Package
    if: ${{ needs.release_please.outputs.releases_created == 'true' }}
    needs: release_please
    permissions:
      contents: read
      id-token: write # Required for OIDC
    runs-on: ubuntu-latest
    outputs:
      dist_tag: ${{ steps.determine_dist_tag.outputs.dist_tag }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: ./.github/actions/prepare

      - name: Determine dist-tag
        id: determine_dist_tag
        run: |
          TAG_NAME="${{ needs.release_please.outputs.tag_name }}"
          echo "Release tag: $TAG_NAME"

          if [[ "$TAG_NAME" == *"-alpha."* ]]; then
            DIST_TAG=alpha
          elif [[ "$TAG_NAME" == *"-beta."* ]]; then
            DIST_TAG=beta
          elif [[ "$TAG_NAME" == *"-rc."* ]]; then
            DIST_TAG=rc
          elif [[ "$TAG_NAME" == *"-"* ]]; then
            DIST_TAG=next
          else
            DIST_TAG=latest
          fi

          echo "dist_tag=$DIST_TAG" >> "$GITHUB_OUTPUT"

      - name: Build and Publish
        run: |
          pnpm build

          echo "Publishing to npm with dist-tag '${{ steps.determine_dist_tag.outputs.dist_tag }}'"
          pnpm publish --tag ${{ steps.determine_dist_tag.outputs.dist_tag }}

  post_release:
    name: Post Release Comments
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - run: echo "npm_version=$(npm pkg get version | tr -d '"')" >> "$GITHUB_ENV"
      - uses: apexskier/github-release-commenter@e7813a9625eabd79a875b4bc4046cfcae377ab34 # v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          comment-template: |
            :tada: This is included in version {release_link} :tada:

            The release is available on:

            * [GitHub releases](https://github.com/JoshuaKGoldberg/eslint-plugin-package-json/releases/tag/{release_tag})
            * [npm package (@${{ needs.publish.outputs.dist_tag }} dist-tag)](https://www.npmjs.com/package/eslint-plugin-package-json/v/${{ env.npm_version }})

            Cheers! ðŸ“¦ðŸš€
